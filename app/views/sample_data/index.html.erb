<div class="fixed inset-x-0 bottom-0 top-20 flex">
  <!-- Left Column -->
  <div class="w-1/3 flex-shrink-0 overflow-y-auto border-r bg-white p-4">
    <!-- Header -->
    <div class="flex-none">
      <h1 class="text-2xl font-bold mb-4">Sample FHIR Resources</h1>
    </div>

    <% if @releases.present? %>
    <!-- Release Selector -->
    <div class="mb-4">
      <%= form_with url: sample_data_path, method: :get, class: "space-y-2" do |f| %>
        <div>
          <%= f.label :release_tag, "Sample Data Release", class: "block text-sm font-medium text-gray-700" %>
          <%= f.select :release_tag,
                        options_for_select(@releases.map { |r| ["[#{r['identifier']}] #{r['description']}", r['identifier']] }, @selected_release_tag),
                        {},
                        { class: "mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md", onchange: 'this.form.submit()' } %>
        </div>
      <% end %>
    </div>

    <!-- Push Data Form -->
    <div class="mb-4 p-4 pt-0 border rounded-lg bg-gray-50">
      <%= form_with url: push_data_sample_data_path, method: :post, class: "space-y-2" do |f| %>
        <div class="text-sm text-gray-700 mb-2">
          <% if session[:fhir_server_url].present? %>
            <h3 class="font-semibold text-lg">FHIR Server</h3>
            <%= session[:fhir_server_url] %>
          <% else %>
            No FHIR server is selected
          <% end %>
        </div>
        <%= f.hidden_field :release_tag, value: @selected_release_tag %>
        <%= f.submit "Push Data to FHIR Server",
              id: "push-data-button",
              class: "w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed",
              disabled: @task_status&.status_running? || session[:fhir_server_url].blank?,
              data: { fhir_server_present: session[:fhir_server_url].present? } %>
      <% end %>
    </div>

    <!-- File Tree -->
    <div id="file-tree-wrapper" class="file-tree <%= 'pointer-events-none opacity-50' if @task_status&.status_running? || @task_status&.status_pending? %>" data-controller="file-tree">
      <% @scenes.each do |scene| %>
        <div class="mb-2">
          <h3 class="font-semibold text-lg"><%= scene['name'] %></h3>
          <ul class="ml-4 list-disc space-y-1">
            <% scene['resources'].select(&:present?).group_by { |r| File.basename(URI.parse(r).path).split('-').first.underscore.humanize.titleize }.each do |resource_type, resources| %>
              <li>
                <span class="font-medium"><%= resource_type %></span>
                <ul class="ml-6 list-circle">
                  <% resources.each do |resource| %>
                    <li>
                      <%= link_to File.basename(URI.parse(resource).path, '.json'),
                                  show_file_sample_data_path(resource_url: resource, release_tag: @selected_release_tag),
                                  data: { turbo_frame: "file_content", action: "click->file-tree#select", "file-tree-target": "link" },
                                  class: "text-blue-600 hover:underline" %>
                    </li>
                  <% end %>
                </ul>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
      <% if @other_resources.present? %>
        <div class="mb-2">
          <h3 class="font-semibold text-lg">Other Resources</h3>
          <ul class="ml-4 list-disc space-y-1">
            <% @other_resources.select(&:present?).group_by { |r| File.basename(URI.parse(r).path).split('-').first.underscore.humanize.titleize }.each do |resource_type, resources| %>
              <li>
                <span class="font-medium"><%= resource_type %></span>
                <ul class="ml-6 list-circle">
                  <% resources.each do |resource| %>
                    <li>
                      <%= link_to File.basename(URI.parse(resource).path, '.json'),
                                  show_file_sample_data_path(resource_url: resource, release_tag: @selected_release_tag),
                                  data: { turbo_frame: "file_content", action: "click->file-tree#select", "file-tree-target": "link" },
                                  class: "text-blue-600 hover:underline" %>
                    </li>
                  <% end %>
                </ul>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>
    <% else %>
      <div class="p-4 border rounded-lg bg-red-50 text-red-700">
        <h3 class="font-semibold text-lg">Error Loading Data</h3>
        <p>Failed to load sample data manifest. Please check the application configuration or network connectivity.</p>
      </div>
    <% end %>
  </div>

  <!-- Right Column -->
  <div class="w-2/3 overflow-y-auto p-6">
    <%= turbo_frame_tag "file_content" do %>
      <% if @task_status %>
        <%= render @task_status %>
      <% else %>
        <div class="text-gray-500 text-center pt-10">
          <p>Select a file from the left to view its content.</p>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
